#!/bin/bash -e

REPO="https://raw.githubusercontent.com/noyuno/dotfiles/master"
getdf="$REPO/bin/dfgetdf"

sshconf()
{
    echo -e "Host github.com\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config
}
sudo apt update
sudo apt -y install \
apt-utils bash wget curl git openssh-client lsb-release \
software-properties-common python-software-properties

cd ~
if [ ! -e ~/.ssh/id_rsa ]; then
    ssh-keygen -t rsa -f ~/.ssh/id_rsa
    cat << EOF
Please register id_rsa.pub to CVS. Then restart script.
GitHub: https://github.com/settings/keys"

EOF

    cat ~/.ssh/id_rsa.pub
    exit 1
fi

if [ -f ~/.ssh/config ]; then
    cat ~/.ssh/config | tr '\n' ' ' | grep -i 'Host github.com[\s]*?StrictHostKeyChecking no' &&:
    if [ $? -ne 0 ]; then 
        sshconf
    fi 
else
    sshconf
fi 
chmod 700 ~/.ssh
chmod 600 ~/.ssh/config
chmod go-w ~

curl -sSL "$getdf" | bash -s ssh

. ~/dotfiles/bin/dflocal $@


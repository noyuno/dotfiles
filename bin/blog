#!/bin/bash -e

help() {
    cat << EOF >&2
blog command
    blog command

command: required one command
    init|i: init repository
    new|n <title>: new article with url-title
    push|p: build and push blog
    compress|c: compress images
    help: show this help
EOF
}

init() {
    git clone git@github.com:noyuno/blog.git $HOME/blog
    git clone git@github.com:noyuno/noyuno.github.io.git $HOME/blog/_site
}

new() {
    base="$HOME/blog"
    title="$1"
    if [ ! "$title" ]; then
        echo "required title" 1>&2
        exit 1
    fi
    if [ ! -d "$HOME/blog" ]; then
        echo "clone blog repo" 1>&2
        exit  1
    fi

    ybase="$base/_posts/$(date +%Y)"
    mkdir -p "$ybase"
    f="$ybase/$(date +%Y-%m-%d)-$title.md"
    if [ ! -f "$f" ]; then
        cp "$HOME/dotfiles/templates/blog.md" "$f"
        sed -i 's|^title:|title: '"'$title'"'|' "$f"
        sed -i 's|^image:|image: /images/'"$(date +%Y-%m-%d)-$title.png"'|' "$f"
    fi
    $EDITOR "$f"
}

push() {
    pushd $HOME/blog >/dev/null
        echo -n "blog: "
        git add .
        git commit -q -m 'Update article' &&:
        git push -q origin master &&:
        echo "ok"
        echo -n "noyuno.github.io: "
        pushd _site >/dev/null
            git clean -fdx
            git checkout .
            git pull -q
        popd >/dev/null
        bundle exec jekyll build -q
        pushd _site >/dev/null
            git add .
            git commit -q -m 'Update article'
            git push -q origin master
        popd >/dev/null
    popd >/dev/null
    echo ok
}

compress () {
    pushd $HOME/blog/images >/dev/null
        pngquant --ext .png -f *.png
    popd >/dev/null
}

case $1 in
i|init) init ;;
n|new) new $2 ;;
p|push) push $* ;;
c|compress) compress ;;
help) help ;;
*) 
    echo "unknown command: $1" 1>&2
    exit 1
    ;;
esac


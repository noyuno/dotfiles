#!/bin/bash -e

#CFLAGS='-g -O0' CPPFLAGS='-I/usr/include/python3.3m -I/usr/include/i386-linux-gnu/python3.3m' \
#CPPFLAGS='-I/usr/include/python3.3m -I/usr/include/i386-linux-gnu/python3.3m' \

. ~/dotfiles/bin/dffunc
require dfdeploy

link()
{
    dfx sudo ln -sfnv "$1" "$2"
}

dfout2 "Getting package for Vim"
aptinstall git build-essential make lua5.3 liblua5.3-dev \
libluajit-5.1 libluajit-5.1-dev python3-dev libpython3-dev libgtk-3-dev

link /usr/include/lua5.3/lauxlib.h /usr/include/lauxlib.h
link /usr/include/lua5.3/lua.h /usr/include/lua.h
link /usr/include/lua5.3/lua.hpp /usr/include/lua.hpp
link /usr/include/lua5.3/luaconf.h /usr/include/luaconf.h
link /usr/include/lua5.3/lualib.h /usr/include/lualib.h
link /usr/lib/x86_64-linux-gnu/libluajit-5.1.so /usr/lib/x86_64-linux-gnu/libluajit.so
link /usr/lib/x86_64-linux-gnu/libluajit-5.1.a /usr/lib/x86_64-linux-gnu/libluajit.a

dfout2 "Getting Vim source"
dfx cd ~
pulled=0
if [ -e vim ]; then
    if [ -d vim ]; then
        dfx cd vim
        dfx git pull origin master --depth 1 &&:
        if [ $? -ne 0 ]; then
            dfx cd ~
            dfx mv vim "$DFTMP"
        fi
        pulled=1
    else
        dfx mv vim "$DFTMP"
    fi
fi

if [ $pulled -ne 1 ]; then
    dfx git clone "https://github.com/vim/vim.git" --depth 1
    dfx cd vim
fi

#LATESTTAG="$(git describe --tags --abbrev=0)"
#echo "checkout $LATESTTAG"
#git checkout "$LATESTTAG"

dfout2 "Configuring Vim"
dfx ./configure \
--with-features=huge \
--with-compiledby="noyuno" \
--enable-multibyte \
--enable-gui=gtk3 \
--enable-rubyinterp \
--enable-python3interp \
--with-python3-config-dir=/usr/lib/python3.5/config-3.5m-x86_64-linux-gnu \
--enable-luainterp=dynamic \
--with-lua-prefix=/usr --with-luajit \
--enable-gpm \
--enable-cscope \
--enable-fontset \
--enable-termtruecolor \
--enable-fail-if-missing

dfout2 "Making Vim"
dfx make -j4
dfx sudo make install

dfx . ~/dotfiles/bin/dfvim-alternatives

finalize dfvim


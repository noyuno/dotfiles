#!/bin/bash -e

. $HOME/dotfiles/bin/dffunc

target=/var/git
user=git
domain=noyuno.mydns.jp

motd()
{
    if [ -e /etc/motd ]; then
        dfx sudo mv /etc/motd /etc/motd.old
    fi
}

httpd()
{
    aptinstall nginx

    sudo domainname $domain

    cat << "EOF" | sudo tee /etc/nginx/sites-available/gitbucket.conf
proxy_cache_path /var/lib/nginx/cache levels=1:2 keys_zone=cache:512m inactive=1d  max_size=60g;

server {
    listen 80;
    server_name git.noyuno.mydns.jp;

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
    proxy_max_temp_file_size 0;

    location / {
        proxy_pass http://localhost:8080;
    }

    location /assets/ {
        proxy_pass              http://localhost:8080/assets/;
        proxy_cache             cache;
        proxy_cache_key         $host$uri$is_args$args;
        proxy_cache_valid       200 301 302 1d;
        expires                 1d;
    }
}
EOF
    dfx sudo ln -sfnv /etc/nginx/sites-available/gitbucket.conf \
        /etc/nginx/sites-enabled/gitbucket.conf
    dfx sudo systemctl reload nginx.service

}

gitbucket()
{
    dfx sudo debconf-set-selections '<<<' 'debconf shared/accepted-oracle-license-v1-1 select true'
    dfx sudo debconf-set-selections '<<<' 'debconf shared/accepted-oracle-license-v1-1 seen true'
    aptinstall oracle-java8-jdk
    dfx sudo mkdir -p $target/repo
    cd $target
    if [ ! -e $target/gitbucket.war ]; then
        dfx sudo wget -qO gitbucket.war \
            'https://github.com/gitbucket/gitbucket/releases/download/4.12.1/gitbucket.war'
    fi

#    cat << EOF | sudo tee /etc/init/gitbucket.conf
#description 'gitbucket'
#author 'noyuno <noyuno@users.noreply.github.com>'
#start on runlevel [2345]
#stop on starting rc RUNLEVEL=[016]
#
#setuid $user
#setgid $user
#
#respawn
#
#exec $target/run.sh
#EOF

    cat << EOF | sudo tee /etc/systemd/system/gitbucket.service
[Unit]
Description=Git hosting service

[Service]
User=git
ExecStart=$target/run.sh

[Install]
WantedBy=multi-user.target
EOF

    cat << EOF | sudo tee $target/run.sh
#!/bin/sh -e
(
/usr/bin/java -jar $target/gitbucket.war --port=8080 \\
    --gitbucket.home=$target/repo
) >>/var/log/gitbucket.log 2>&1
EOF
    dfx sudo chmod +x $target/run.sh

    cat << EOF | sudo tee /etc/logrotate.d/gitbucket
/var/log/gitbucket.log {
    weekly
    coppytruncate
    rotate 52
    ocmpress
    delaycompress
    notifempty
}
EOF

    id $user 1>/dev/null 2>&1 &&:
    if [ $? -ne 0 ]; then
        dfx sudo useradd -d $target -s /bin/zsh $user
    fi
    dfx sudo chown -R $user:$user $target
    
    dfx sudo touch /var/log/gitbucket.log
    dfx sudo chown $user:$user /var/log/gitbucket.log

    dfx sudo systemctl daemon-reload
    dfx sudo systemctl restart gitbucket.service
}

if [ $# -eq 0 ]; then
    motd
    gitbucket
else
    eval $*
fi


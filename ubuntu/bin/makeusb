#!/bin/bash -e

. $HOME/dotfiles/bin/dffunc

iso=$HOME/Downloads/ubuntu-mate-16.04.2-desktop-amd64.iso
usbm=/mnt/usb

download()
{
    dfx wget -NO "$iso" \
    'http://cdimage.ubuntu.com/ubuntu-mate/releases/16.04.2/release/ubuntu-mate-16.04.2-desktop-amd64.iso'
}

partitioning()
{
    dfx sudo umount "$usb"1 &&:
    dfx sudo parted -s "$usb" -a optimal -- \
        mklabel msdos \
        mkpart primary 1 -1 \
        set 1 boot on
    dfx sudo sync
    dfx sudo mkfs.vfat -F 32 "$usb"1
    dfx sudo sync
}

targetmount()
{
    dev=$1
    dir=$2
    shift; shift
    options=$*
    m=$(mount | grep "^$dev\ ") &&:
    if [ ! "$m" ]; then
        dfx sudo mount $options "$dev" "$dir"
    elif [[ ! "$m" =~ ^$dev\ on\ $dir\  ]]; then
        echo "$dev already mounted at other point\n$m" >&2
        exit 1
    else
        echo "already mounted $dev on $dir"
    fi
}

copyiso()
{
    dfx sudo mkdir -p $usbm
    targetmount "$iso" /mnt/iso -o loop
    targetmount "$usb"1 /mnt/usb
    #dfx sudo cp -a /mnt/iso/* $usbm
    dfx sudo rsync -a /mnt/iso/* $usbm &&:
    ret=$?
    if [ $ret -ne 0 -a $ret -ne 23 ]; then
        echo "rsync fatal error" >&2
        exit $ret
    fi
    dfx sudo sync
    dfx sudo umount /mnt/iso
}

ddiso()
{
    dfx sudo dd if="$iso" of=$usb bs=512k
    dfx sudo sync
}

bootable()
{
    u=$(echo "$usb" | awk -F/ '{print $3}')
    uuid=$(command ls -l /dev/disk/by-uuid | awk -F ' ' "/${u}3/"'{ print $9 }')
    dfx sudo syslinux /dev/disk/by-uuid/$uuid
    dfx sudo dd bs=440 count=1 conv=notrunc if=/usr/lib/syslinux/mbr/mbr.bin of="$usb"
}

copykey()
{
    mail=$(gpg2 --list-secret-keys|grep \< --color=no | sed -e 's/^.* <//' -e 's/>$//'|head -n 1)
    dfx mkdir -p $usbm/key
    dfx gpg2 -a --export "$mail" > $usbm/key/public.gpg2
    dfx gpg2 -a --export-secret-keys "$mail" > $usbm/key/secret.gpg2
    dfx gpg2 --export-ownertrust "$mail" > $usbm/key/ownertrust
}

copydotfiles()
{
    dfx zip -qr $usbm/dotfiles.zip $HOME/dotfiles
}

help()
{
    (cat << EOF
makeusb device separation
device: usb device file [/dev/sdd]
separation: usb separation size (64G storage -> 58G separate)

EOF
    )>&2
    exit 1
}

# http://stackoverflow.com/questions/19713918/how-to-load-luks-passphrase-from-usb-falling-back-to-keyboard
# http://www.cheshirekow.com/wordpress/?p=810

if [ $# -eq 1 ]; then
    usb="$1"
    #separate="$2"
    dfx sudo fdisk -l "$usb"
    echo -en "\e[31mAre you sure to remove all data in $usb? [enter]\e[m"
    read
    [ ! -e "$iso" ] && download
    ddiso
    copykey
    copydotfiles
else
    help
fi


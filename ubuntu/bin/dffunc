#!/bin/bash -e

need_install_ret=0
need_install()
{
    need_install_ret=0
    while [ $# -gt 0 ] ; do
        dpkg -s "$1" 2>/dev/null | grep -e 'Status.*installed' >/dev/null &&:
        if [ $? -ne 0 ]; then
            need_install_ret=1
            break
        fi
        shift
    done
}
export -f need_install

aptinstall()
{
    need_install $* &&:
    if [ $need_install_ret -eq 1 ]; then
        dfx sudo DEBIAN_FRONTEND=noninteractive apt $APTFLAG \
        -o DPkg::options::="--force-confdef" \
        -o DPkg::options::="--force-confold" -y install $@ 
    else
        dfout3 'All packages has been installed: '"$*"
    fi
}
export -f aptinstall 

aptupgrade()
{
    dfx sudo DEBIAN_FRONTEND=noninteractive apt $APTFLAG \
    -o DPkg::options::="--force-confdef" \
    -o DPkg::options::="--force-confold" -y full-upgrade
}
export -f aptupgrade

clean_list=0
aptupdate()
{
    if [ $clean_list -eq 0 ]; then
        dfx sudo apt $APTFLAG update
        clean_list=1
    fi
}
export -f aptupdate

aptremove()
{
    dfx sudo DEBIAN_FRONTEND=noninteractive apt $APTFLAG \
        -o DPkg::options::="--force-confdef" \
        -o DPkg::options::="--force-confold" -y --purge remove $*
}

sedapt()
{
    if [ -z "$DRYRUN" ]; then
        dfx cp /etc/apt/sources.list "$DFBACKUP/sources.list.sed"
        dfx sed -i.old "$1" "$DFBACKUP/sources.list.sed"
        dfx sudo mv "$DFBACKUP/sources.list.sed" /etc/apt/sources.list
        clean_list=0
    fi
}
export -f sedapt

addapt()
{
    if [ "$1" ]; then
        apt-cache policy | grep "$1" >/dev/null &&:
        if [ $? -ne 0 ]; then 
            dfx sudo add-apt-repository -y "$1"
            clean_list=0
        fi 
    fi
}
export -f addapt

if [ -z "$APTFLAG" ]; then
    APTFLAG="-qq"
fi

